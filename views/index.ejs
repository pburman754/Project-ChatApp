<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Whatsapp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/chats">
                <i class="fas fa-comments"></i>
                ChatApp
            </a>
            <div class="d-flex">
                <a href="/chats/new" class="btn btn-success me-2">
                    <i class="fas fa-plus"></i> New Chat
                </a>
                <a href="/logout" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="container chat-container">
            <%- include('partials/flash') %>
            <div class="chat-header mb-4">
                <h2><i class="fas fa-comments"></i> Conversations</h2>
                <p>Welcome back, <strong><%= currentUser.username %></strong>! Your chat conversations.</p>
            </div>
            
            <% if (chats.length === 0) { %>
                <div class="empty-state text-center py-5">
                    <i class="fas fa-comment-slash fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No conversations yet</h4>
                    <p class="text-muted">Start a new chat to begin messaging!</p>
                    <a href="/chats/new" class="btn btn-primary btn-lg mt-3">
                        <i class="fas fa-plus"></i> Start Your First Chat
                    </a>
                </div>
            <% } else { %>
                <div class="conversations-list">
                    <% chats.forEach(chat => { %>
                        <% const otherUser = chat.from === currentUser.username ? chat.to : chat.from; %>
                        <% const participants = [chat.from, chat.to].sort().join('-'); %>
                        <div class="conversation-item">
                            <a href="/chats/conversation/<%= participants %>" class="conversation-link text-decoration-none">
                                <div class="conversation-avatar">
                                    <div class="avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <%= otherUser.charAt(0).toUpperCase() %>
                                    </div>
                                </div>
                                <div class="conversation-content">
                                    <div class="conversation-header d-flex justify-content-between">
                                        <h6 class="conversation-title">
                                            Conversation with: <strong><%= otherUser %></strong>
                                        </h6>
                                        <span class="conversation-time text-muted small" data-time="<%= chat.created_at.toISOString() %>">
                                            <%= new Date(chat.created_at).toLocaleTimeString() %>
                                        </span>
                                    </div>
                                    <div class="conversation-preview">
                                        <p class="text-muted mb-0"><%= chat.msg %></p>
                                    </div>
                                </div>
                            </a>
                            <form method="POST" action="/chats/conversation/<%= participants %>?_method=DELETE" class="delete-form">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.min.js"></script>
    <script>
        const timeagoInstance = timeago();
        const timeElements = document.querySelectorAll('.conversation-time');
        timeElements.forEach(el => {
            el.textContent = timeagoInstance.format(el.dataset.time);
        });
    </script>
</body>
</html>
